---
title: "Application of Huynh 2020 Interim Analysis methods to assessed stocks from the US South Atlantic"
author: "Nikolai Klibansky"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    fig_caption: yes
    extra_dependencies:
      longtable: null
      xcolor: null
      pdflscape: null
urlcolor: blue
---

```{r setup, include=FALSE, echo=FALSE}
rm(list=ls())
knitr::opts_chunk$set(comment=NA,echo=FALSE,message=FALSE,warning=FALSE,fig.width=8,fig.height=10)

library(Hmisc)
library(knitr)
library(latex2exp) # lets you use TeX() function to convert latex equations to R expressions for plotting
library(openMSE)
library(stringr)
library(bamExtras)
library(bamMSE)


#source('fn/iMP.R')
# Compute U (harvest rate) from F
F2U <- function(F){1 - exp(-F)}

# Median without NA
median_noNA <- function(x){median(x,na.rm=TRUE)}
```

```{r user}
# Should individual PDFs be produced (or just plot in Rmd output)
plot_pdf <- TRUE

OMNames_user <- c("OM_BlackSeaBass",
                  "OM_VermilionSnapper",
                  "OM_RedPorgy",
                   #"OM_Tilefish","OM_Cobia",
                  "OM_SnowyGrouper"#,
                  #"OM_GagGrouper"
                   )
Names_user <- gsub("^OM_","",OMNames_user)

OMNames_huynh <- c("OM_CapelinHuynh", "OM_PacificOceanPerchHuynh", "OM_VermilionSnapperHuynh")

scenNames_user1 <-  c("base","dep","lf","ucvhi","ubias","ucvlo")
scenNames_user2 <-  c("base","rc","minerr","minrecdev","vtiv")
scenNames_user3 <-  c("base","noempind",
                      "nolag","perfobs","tachi")
scenNames_user4 <-  c("base","lhset","Mset","steepset","agevarM"#,"epiM"
                      )

# All scenarios
scenNames_user <- unique(c(scenNames_user1,scenNames_user2,scenNames_user3,scenNames_user4))

# Alternative realities
# These scenarios are considered equally plausible, for the purposes of
# averaging results together. Most other scenarios could be considered sensitivities.
# scenNames_user_alt <- scenNames_user1

scenNames_key <- c("agevarM"="Age-varying M",
                   "base"="Base",
                   "dep"="Depleted",
                   "epiM"="Episodic M",
                   "hd"="Hyper-deplete",
                   "hs"="Hyper-stable",
                   "lf"="Lightly fished",
                   "lhset"="Set M and steep",
                   "mconst"="M constant",
                   "minerr"="Minimal error",
                   "minrecac"="Minimal rec AC",
                   "minrecdev"="Minimal rec devs",
                   "Mset"="Set M",
                   "noempind"="No empirical indices",
                   "nolag"="No data lag",
                   "perfobs"="Perfect observation",
                   "rc"="Regime\nchange",
                   "steepset"="Set steepness",
                   "tachi"="TAC 1.25MSY",
                   "ubias"="Index\nbiased",
                   "ucvhi"="Index\nHigh CV",
                   "ucvlo"="Index\nLow CV",
                   "vtiv"="V time invariant"
                   )

MPNamesAll <-         c(#"AvC", "CC1", "DCAC","DBSRA","SPMSY",
                        "SCA_1","SCA_5","SCA_10",
                        "pMP_5","pMP_10",                        
                        "iMP_avg_5","iMP_avg_10",
                        "iMP_buffer_5","iMP_buffer_10"
                        )

MPNamesAll_key <- c("AvC"="average catch",
                    "CC1"="average catch (last 5 yr)",
                    "DCAC"= "depletion corrected average catch",
                    "DBSRA" = "depletion based stock reduction analysis",
                    "SPMSY" = "surplus production model",
                    "SCA_1" = "Annual assessment",
                    "SCA_5" = "Fixed TAC (5)",
                    "SCA_10"= "Fixed TAC (10)",
                    "iMP_avg_5" = "Avg. index (5)",
                    "iMP_avg_10" = "Avg. index (10)",
                    "iMP_buffer_5" = "Buffer index (5)",
                    "iMP_buffer_10" = "Buffer index (10)",
                    "pMP_5" = "Projection (5)",
                    "pMP_10" = "Projection (10)"
                        )
MPNamesAll_legtext <- MPNamesAll

MPNamesSub_user <- c("SCA_1","SCA_5","SCA_10","iMP_avg_10","iMP_buffer_10")
MPNamesSub_user_legtext <- MPNamesAll_key[MPNamesSub_user]
```

## Built in performance metrics (PMs)

* `P10`	  Probability B > 0.1 BMSY
* `P50`	  Probability B > 0.5 BMSY
* `P100`  Probability B > BMSY
* `PNOF`  Probability F < FMSY
* `LTY`	  Probability Long-Term Yield > 0.5 Relative Yield
* `STY`	  Probability Short-Term Yield > 0.5 Relative Yield
* `AAVY`	Probability AAVY < 0.2 (Average Annual Variability in Yield)
* `AAVE`	Probability AAVE < 0.2 (Average Annual Variability in Effort)
* `Yield`	Average Yield (relative to Reference Yield)

- can easily vary reference values and years
- PMs compute probabilities across years for each simulation and return mean values across simulations (but we could recompute them however we want from the raw MSE objects)

```{r functions}
# color function like rainbow() but without yellow (or indigo)
ROGBP <- colorRampPalette(c("red","orange","green","blue","purple"))
# Makes an ROGBP function with an alpha channel
ROGBP_alpha <- function(alpha){
  x <- colorRampPalette(c(
    rgb(1,0,0,alpha), # red
    rgb(1,0.5,0.25,alpha), # orange
    rgb(0,1,0,alpha), # green 
    rgb(0,0,1,alpha), # blue
    rgb(0.5,0,0.5,alpha)), # purple
    alpha=TRUE)
  return(x)
}

# Turn hexadecimal color opaque
makeOpaque <-      function(hexcolor){gsub(".{2}$","FF",hexcolor)}

P75 <- function(...,Ref=0.75){P50(...,Ref=Ref)}

AAVY10 <- function(MSEobj = NULL, Ref = 0.1, Yrs = NULL){AAVY(MSEobj = MSEobj, Ref = Ref, Yrs = Yrs)}

```

```{r plot_LH function}
plot_LH <- function(OM,...){
maxage <- OM@maxage
agebins <- 0:maxage
lenbins <- vb_len(Linf=OM@Linf[1],K=OM@K[1],t0=OM@t0[1],a=agebins)
Plenbins <- lenbins/max(lenbins)
styr_proj <- OM@nyears+1
Mat_age <- apply(OM@cpars$Mat_age[,,styr_proj],2,mean) # Maturity at age
V <- apply(OM@cpars$V[,,styr_proj],2,mean) # Vulnerability (selectivity) at age

plot(agebins,Plenbins,ylim=c(0,1),type="l",lwd=3,...)
points(agebins,Mat_age,type="l",lwd=3,lty=2)
points(agebins,V,type="l",lwd=3,lty=3)
}
```

```{r plot_MSE_ts function}
# Time series plots

plot_MSE_ts <- function(
myvarName="SSB",
myvarDenomExpr = NULL,
ylabel = myvarName,
FUN = mean,
scenNames,
OMNames,
MPNamesSub = NULL,
MPNamesSub_legtext=MPNamesSub,
MPNamesRef = NULL, # Name of reference MP
FUNRef = function(myvarsubStat,MPNamesRef){ # Function for comparing MPs with reference MP
  (myvarsubStat-myvarsubStat[,MPNamesRef])/myvarsubStat[,MPNamesRef]},
legtext_o = NULL, # order for plotting legend text
MSEoutNames = paste0(rep(gsub("OM","MSE",OMNames),each=length(scenNames)),
                     "_",
                     rep(scenNames,length(OMNames))
                     ),
colLabs = str_replace_all(gsub("OM_","",OMNames),"(?<=[a-z])(?=[A-Z])"," "),
rowLabs = scenNames,
sims = NULL, # which simulation runs should be used to generate the plot when plot_type="sims"?
plot_type="huynh", # "huynh" plots time series by MP like in the Huynh et al paper
                   # "boot" plots times series of bootstrapped data  with bamExtras::plot_boot_vec
                   # "phase" plots phase plots of F/Fmsy versus SSB/SSBmsy
                   # "tradeoff" plots tradeoff plots by MP
                   # "addind" plot additional indices from AddInd
                   # "sims" plot time series for individual sim runs
proyear_phase=NULL,
proyear_phase_FUNName="median",
PMx = Yield, # Performance metric function x (x-axis) for tradeoff plots)
PMy = P100, # Performance metric function y (y-axis) for tradeoff plots)
PMx_Yrs=-10, # Defaults to the last 10 years 
PMy_Yrs=-10, # Defaults to the last 10 years
mar=c(1,1,1,1),
oma=c(6,4,3,3),
mgp=c(1.5,0.2,0),
cols = setNames(ROGBP_alpha(0.5)(length(MPNamesSub)),MPNamesSub),
ltys = setNames(rep(1,length(MPNamesSub)),MPNamesSub),
pchs = setNames(rep(16,length(MPNamesSub)),MPNamesSub),
lwds = setNames(rep(3,length(MPNamesSub)),MPNamesSub),
types = setNames(rep("l",length(MPNamesSub)),MPNamesSub),
xlabel = "Management year",
main_line = 1, # Line for main column labels
xlim = NULL,
ylim = NULL,
assessmentYears=NULL,
x.at = NULL,
y.at = NULL,
# leg.x=NULL,
# leg.y =NULL,
legend_panel=NULL,
legend_cex= 1,
legend_x="bottomleft",
legend_inset=c(0,-0.5),
label_axes="all", # "all" labels all panels, "leftbottom" labels y axes on the left and x axes on the bottom panels
hline=NULL, # values to pass into abline(h=hline)
vline=NULL, # values to pass into abline(v=vline)
hline_lty=3,
vline_lty=3,
...
){
if(is.null(legtext_o)){
  legtext_o <- seq_along(MPNamesSub)
}
  
xlim_user <- xlim
ylim_user <- ylim
x.at_user <- x.at
y.at_user <- y.at

colLabsAll = as.character(matrix(c(colLabs,rep("",length(MSEoutNames)-length(colLabs))),ncol=length(colLabs),byrow=TRUE))
rowLabsAll = as.character(matrix(c(rep("",length(MSEoutNames)-length(rowLabs)),rowLabs),nrow=length(rowLabs),byrow=FALSE))

dim1 <- length(rowLabs)
dim2 <- length(colLabs)

if(plot_type=="addind"){
  mfcol <- c(dim2,dim1)}else{
  mfcol <- c(dim1,dim2)
}

par(mfcol=mfcol,mgp=mgp,mar=mar,oma=oma,tck=-0.01,xpd=FALSE,xaxs="r",yaxs="r")

### LOOP THROUGH MSE OBJECTS
for(outName_i in MSEoutNames){
topPanels <- (length(scenNames)*(seq_along(OMNames)-1)+1)
bottomPanels <- length(scenNames)*seq_along(OMNames)
leftPanels <- seq_along(scenNames)
rightPanels <- tail(seq_along(MSEoutNames),length(scenNames))
  
i <- which(MSEoutNames==outName_i)
out_i <- get(outName_i)
MPNames <- out_i@MPs
    
if(is.null(sims)){
  sims <- 1:out_i@nsim
}
if(!is.expression(myvarName)){
  myvar <- slot(out_i,myvarName)  
}else{
  myvar <- eval(myvarName) 
}

nyears_i <- out_i@nyears
proyears_i <- out_i@proyears
LHyear_i <- out_i@Hist@Data@LHYear # Last historic year
histYears <- sort(LHyear_i - ((1:nyears_i)-1))
projYears_i <- LHyear_i+1:proyears_i

legend_panel <- bottomPanels[1]

if(!is.null(myvarDenomExpr)){
myvarDenom <- eval(myvarDenomExpr)
myvar <- myvar/myvarDenom # Scale myvar
}

xaxt_i <- ifelse(i%in%bottomPanels,"n","n")
yaxt_i <- ifelse(i%in%leftPanels,"n","n")

MPNamesSubix <- match(MPNamesSub,MPNames)

if(plot_type=="huynh"){
if(!is.null(dim(myvar))){
myvarsub <- myvar[,match(MPNamesSub,MPNames),]
myvarsubStat <- apply(myvarsub,2,function(x){apply(x,2,FUN)})
}else{
myvarsubStat <- matrix(rep(myvar,length(MPNamesSub)),ncol=length(MPNamesSub))  
}
dimnames(myvarsubStat) <- list(1:nrow(myvarsubStat),MPNamesSub)

if(!is.null(MPNamesRef)){
myvarsubStat <- FUNRef(myvarsubStat,MPNamesRef)
}

if(is.null(ylim_user)){
  ylim <- range(myvarsubStat,na.rm=TRUE)
}
if(is.null(xlim_user)){
  xlim <- range(projYears_i,na.rm=TRUE)
}

matplot(projYears_i#as.numeric(rownames(myvarsubStat))
        ,myvarsubStat,
        col=cols,lty=ltys,lwd=lwds,type=types,
        xaxt=xaxt_i,yaxt=yaxt_i,
        xlim=xlim,ylim=ylim,xlab="",ylab="",...)
#title(main=colLabsAll[i],line=1)

grid(nx=NA,ny=NULL)
abline(v=assessmentYears,lty="1111",lwd=2)
}
    if(plot_type=="sims"){
      cols <-  ROGBP(length(sims))
      ltys <-  1:length(MPNamesSub)
      pchs <-  NA
      lwds <-  3
      types <- "l"
      
      myvarsub <- myvar[sims,match(MPNamesSub,MPNames),,drop=FALSE]
      dimnames(myvarsub) <- list(sims,MPNamesSub,1:proyears_i)
      
      if(!is.null(MPNamesRef)){
        myvarsub <- FUNRef(myvarsub,MPNamesRef)
      }
      
      if(is.null(ylim_user)){
        ylim <- range(myvarsub,na.rm=TRUE)
      }
      if(is.null(xlim_user)){
        xlim <- range(projYears_i,na.rm=TRUE)
      }
      
      for(MP_j in MPNamesSub){
      j <- match(MP_j,MPNamesSub)
      myvarsub_j <- myvarsub[,j,]
      lty <- ltys[j]
      if(j==1){
      matplot(projYears_i,
              t(myvarsub_j), 
              col=cols,lty=lty,lwd=lwds,type=types,
              xaxt=xaxt_i,yaxt=yaxt_i,
              xlim=xlim,ylim=ylim,xlab="",ylab="",...)
      #title(main=colLabsAll[i],line=1)
      
      grid(nx=NA,ny=NULL)
      abline(v=assessmentYears,lty=2,lwd=1)
      }else{
        matpoints(t(myvarsub_j), 
                col=cols,lty=lty,lwd=lwds,type=types
                )        
      }
    }
    }

if(plot_type=="addind"){
  PPDYears_i <- local({
    a <- c(histYears,projYears_i)
    a[-length(a)]
  })
if(is.null(assessmentYears)){
assessmentYears <- apply(do.call(cbind,lapply(out_i@PPD[[MPNamesSub]]@Misc,FUN=function(x){x1 <- x$diagnostic; unlist(lapply(x1,FUN=function(xx){xx$Year}))})),1,median)
}
      
if(!is.null(dim(myvar))){
myvarsub <- myvar
#myvarsubStat <- apply(myvarsub,2,function(x){apply(x,2,FUN)})
}else{
  warning("is.null(dim(myvar) == TRUE. No option currently available for this situation.")
}
dimnames(myvarsub) <- list("sim"=1:dim(myvarsub)[1],"AddInd"=1:dim(myvarsub)[2],"Year"=PPDYears_i)
if(is.null(ylim_user)){
  ylim <- range(myvarsub,na.rm=TRUE)
}
if(is.null(xlim_user)){
  xlim <- range(PPDYears_i,na.rm=TRUE)
}
# n_AddInd <- ncol(myvarsubStat)
# cols <-  ROGBP_alpha(0.5)(n_AddInd)
# matplot(PPDYears_i,myvarsubStat,
#         col=cols,lty=ltys,lwd=lwds,type=types,
#         xaxt=xaxt_i,yaxt=yaxt_i,
#         xlim=xlim,ylim=ylim,xlab="",ylab="")
#title(main=colLabsAll[i],line=1)
n_AddInd <- dim(myvarsub)[2]
col_AddInd <- ROGBP(n_AddInd)
for(j in 1:n_AddInd){

plot_boot_vec(myvarsub[,j,],
              col_lines = col_AddInd[j],
              add=ifelse(j!=1,TRUE,FALSE),
              xlim=xlim,ylim=ylim,...)

}
grid(nx=NA,ny=NULL)
abline(v=assessmentYears,lty=2,lwd=1)
}

if(plot_type=="boot"){
  if(is.null(ylim_user)){
  ylim <- range(myvar,na.rm=TRUE)
}
  bamExtras::plot_boot_vec(myvar,ylim=ylim)
  abline(v=out_i@nyears,lwd=2,lty=2) # Plot vertical line at end of historical period
}

if(plot_type=="phase"){
ltys <-  setNames(rep(0,length(MPNamesSub)),MPNamesSub)
# pchs <-  setNames(rep(1,length(MPNamesSub)),MPNamesSub)
lwds <-  setNames(rep(0,length(MPNamesSub)),MPNamesSub)
types <- setNames(rep("p",length(MPNamesSub)),MPNamesSub)  
xlabel <- "F/Fmsy"  
ylabel <- "SSB/SSBmsy"  

if(is.null(proyear_phase)){
  proyear_phase <- out_i@proyears
}
proyear_phase_FUN <- get(proyear_phase_FUNName)
Bstatus <- out_i@SB_SBMSY[,MPNamesSubix,proyear_phase,drop=FALSE] %>% apply(1:2,proyear_phase_FUN)
Fstatus <- out_i@F_FMSY[,MPNamesSubix,proyear_phase,drop=FALSE] %>% apply(1:2,proyear_phase_FUN)

matplot(Fstatus,Bstatus,
        col=cols,lty=ltys,lwd=lwds,pch=pchs,type=types,
        xaxt=xaxt_i,yaxt=yaxt_i,
        xlab="",ylab="",xlim=xlim,ylim=ylim,
        ...
        )
points(apply(Fstatus,2,median),
       apply(Bstatus,2,median),pch=21,cex=3,lwd=2,col="black",bg=makeOpaque(cols))

  abline(v=1,lty=3)
  abline(h=1,lty=3)

if(i%in%topPanels&i%in%leftPanels){
  if(length(proyear_phase)>1){
    leg_text_phase <- paste0(proyear_phase_FUNName,"(proyears ",paste(range(proyear_phase),collapse="-"),")")
  }else{
    leg_text_phase <- paste0("proyear ",proyear_phase)
  }
  legend("topright",legend=leg_text_phase,bty="n",text.col="black",text.font = 2)
}  
    
}

if(plot_type=="tradeoff"){
  out_i <- get(outName_i)

PMx_out <- PMx(out_i,Yrs=PMx_Yrs)
PMy_out <- PMy(out_i,Yrs=PMy_Yrs)

plot(PMx_out@Mean[MPNamesSubix],PMy_out@Mean[MPNamesSubix],pch=16,col=cols,
     xaxt=xaxt_i,yaxt=yaxt_i,
     xlab="",ylab="",
     xlim=xlim,ylim=ylim,
     ...)

# legend("top",legend=MPs,col=MPcols,pch=16,bty="n")

ltys <-  setNames(rep(0,length(MPNamesSub)),MPNamesSub)
lwds <-  setNames(rep(0,length(MPNamesSub)),MPNamesSub)
types <- setNames(rep("p",length(MPNamesSub)),MPNamesSub)  
xlabel <- PMx_out@Caption 
ylabel <- PMy_out@Caption

}

if(!is.null(hline)){
abline(h=hline,lty=hline_lty)
}
if(!is.null(vline)){
abline(v=vline,lty=vline_lty)
}

if(is.null(x.at_user)){
  x.at <- pretty(par("usr")[1:2])
}
if(is.null(y.at_user)){
  y.at <- pretty(par("usr")[3:4])
}

if(i%in%topPanels){
col.ct <- which(topPanels==i)
mtext(colLabsAll[i],side=3,line=main_line,outer=FALSE,font=2)
}

if(i%in%rightPanels){
row.ct <- which(rightPanels==i)
rowcenter <-par("usr")[3]+diff(par("usr")[3:4])/2
text(x=par("usr")[2]+diff(par("usr")[1:2])*0.1
     ,y=rowcenter,rowLabsAll[i],
     srt=-90,xpd=NA,font=2)
}

if(label_axes=="all"){
  x.at.i <- x.at
  axis(side=1,at=x.at.i)
  y.at.i <- y.at
  axis(side=2,at=y.at.i)
}
if(label_axes=="leftbottom"){
  if(i%in%bottomPanels){
    x.at.i <- x.at
    if(i>bottomPanels[1]){x.at.i <- x.at[-1]}
    axis(side=1,at=x.at.i,outer=TRUE)
  }
  if(i%in%leftPanels){
    y.at.i <- y.at
    if(i>leftPanels[1]){y.at.i <- y.at[1:(length(y.at)-1)]}
    axis(side=2,at=y.at.i,outer=TRUE)
  }
}  

if(i==legend_panel&plot_type%in%c("huynh","phase","tradeoff")){
   legend(legend_x,
          inset=legend_inset,
       horiz=TRUE,bty="n",
       legend=MPNamesSub_legtext[legtext_o],
       col=makeOpaque(cols)[legtext_o],lty=ltys[legtext_o],lwd=lwds[legtext_o],pch=pchs[legtext_o],
       cex=legend_cex,
       xpd=NA,
       x.intersp=0.5
       ) 

}
}

mtext(ylabel,side=2,line=par("mgp")[1],outer=TRUE)
mtext(xlabel,side=1,line= par("mgp")[1],outer=TRUE)

}
```

```{r plot_MSE_dw function}
# Dot and whisker plots

plot_MSE_dw <- function(
myvarName,
myvarDenomExpr = NULL,
ylabel = myvarName,
FUN = cv,  # MSEtool::cv
scenNames,
OMNames,
MPNamesSub = c("SCA_10","SCA_1","iMP_avg_10","iMP_buffer_10"),
MPNamesSub_legtext=MPNamesSub,
legtext_o = c(3,2,1,4), # order for plotting legend text
MSEoutNames = paste0(rep(gsub("OM","MSE",OMNames),each=length(scenNames)),
                     "_",
                     rep(scenNames,length(OMNames))
                     ),
colLabs = str_replace_all(gsub("OM_","",OMNames),"(?<=[a-z])(?=[A-Z])"," "),
rowLabs = scenNames,

mar=c(0,0,0,0),
oma=c(10,4,3,3),
mgp=c(1,0.3,0),
cols = setNames(ROGBP(length(MPNamesSub)),MPNamesSub),
ltys = setNames(rep(1,length(MPNamesSub)),MPNamesSub),
lwds = setNames(rep(1,length(MPNamesSub)),MPNamesSub),
pchs = setNames(rep(16,length(MPNamesSub)),MPNamesSub),
types = setNames(rep("l",length(MPNamesSub)),MPNamesSub),
textlabpos = rep("lo",length(MSEoutNames)),#c(rep("lo",6),rep("up",7),"lo",rep("up",4)),
xlabel = "Management procedure",
xlabel_line=9,
xlim = NULL,
ylim = c(0,0.6),
x.at = NULL,
y.at = NULL,
# leg.x=NULL,
# leg.y =NULL,
# legend_panel=NULL,
# legend_cex= 1,
# legend_x="bottomleft",
# legend_inset=c(0,-0.6),
label_axes="leftbottom", # "all" labels all panels, "leftbottom" labels y axes on the left and x axes on the bottom panels
hline=1 # values to pass into abline(h=hline)
){
  
xlim_user <- xlim
ylim_user <- ylim
x.at_user <- x.at
y.at_user <- y.at

colLabsAll = as.character(matrix(c(colLabs,rep("",length(MSEoutNames)-length(colLabs))),ncol=length(colLabs),byrow=TRUE))
rowLabsAll = as.character(matrix(c(rep("",length(MSEoutNames)-length(rowLabs)),rowLabs),nrow=length(rowLabs),byrow=FALSE))

nrow <- length(rowLabs)
ncol <- length(colLabs)

par(mfcol=c(nrow,ncol),mgp=mgp,mar=mar,oma=oma,tck=-0.01,xpd=FALSE,xaxs="i",
    yaxs="r",lend="butt")

for(outName_i in MSEoutNames){
topPanels <- (length(scenNames)*(seq_along(OMNames)-1)+1)
bottomPanels <- length(scenNames)*seq_along(OMNames)
leftPanels <- seq_along(scenNames)
rightPanels <- tail(seq_along(MSEoutNames),length(scenNames))
  
i <- which(MSEoutNames==outName_i)
out_i <- get(outName_i)
MPNames <- out_i@MPs
if(!is.expression(myvarName)){
myvar <- slot(out_i,myvarName)  
}else{
myvar <- eval(myvarName) 
}

legend_panel <- bottomPanels[1]

if(!is.null(myvarDenomExpr)){
myvarDenom <- eval(myvarDenomExpr)
myvar <- myvar/myvarDenom # Scale myvar
}

if(!is.null(dim(myvar))){
myvarsub <- myvar[,match(MPNamesSub,MPNames),]
myvarsubStat <- apply(myvarsub,2,function(x){apply(x,2,FUN)})
}else{
myvarsubStat <- matrix(rep(myvar,length(MPNamesSub)),ncol=length(MPNamesSub))  
}
dimnames(myvarsubStat) <- list(1:nrow(myvarsubStat),MPNamesSub)

xaxt_i <- ifelse(i%in%bottomPanels,"n","n")
yaxt_i <- ifelse(i%in%leftPanels,"n","n")

if(is.null(xlim_user)){
  xlim <- c(0,length(MPNamesSub)+1)
}

################################

Statmed <- apply(myvarsubStat,2,median)
Statmedtext <- round(Statmed,2)
StatQ1 <- apply(myvarsubStat,2,quantile,probs=0.25,na.rm=TRUE)
StatQ3 <- apply(myvarsubStat,2,quantile,probs=0.75,na.rm=TRUE)

xaxt_i <- ifelse(i%in%bottomPanels,"n","n")
yaxt_i <- ifelse(i%in%leftPanels,"n","n")
x <- seq_along(MPNamesSub)
plot(x,Statmed,
        col=cols,pch=pchs,type="n",bg="white",
        xaxt=xaxt_i,yaxt=yaxt_i,
        xlim=xlim,ylim=ylim,xlab="",ylab="")
arrows(x0=x,y0=StatQ1,y1=StatQ3,
       col=cols,lty=ltys,lwd=lwds,length=0
       )
points(x,Statmed,
        col=cols,pch=pchs,type="p",bg="white",cex=1.2,
        xaxt=xaxt_i,yaxt=yaxt_i,
        xlim=xlim,ylim=ylim,xlab="",ylab="")

if(textlabpos[i]=="lo"){text(x=x,y=rep(par("usr")[3]),labels=Statmedtext,srt=90,adj=c(-0.1,0.5),font=2)}
if(textlabpos[i]=="up"){text(x=x,y=rep(par("usr")[4]),labels=Statmedtext,srt=90,adj=c(1.2,0.5),font=2)}

################################

if(i%in%topPanels){
col.ct <- which(topPanels==i)
mtext(colLabsAll[i],side=3,line=1,outer=FALSE,font=2)
}

if(i%in%rightPanels){
row.ct <- which(rightPanels==i)
rowcenter <-par("usr")[3]+diff(par("usr")[3:4])/2

text(x=par("usr")[2]*1.05,y=rowcenter,rowLabsAll[i],
     srt=-90,xpd=NA,font=2)
}

if(label_axes=="all"){
  x.at.i <- x.at
  axis(side=1,at=x.at.i)
  y.at.i <- y.at
  axis(side=2,at=y.at.i)
}
if(label_axes=="leftbottom"){
  if(i%in%bottomPanels){
    x.at.i <- x.at
    if(i>bottomPanels[1]){x.at.i <- x.at[-1]}
    # axis(side=1,at=x.at.i)
    axis(side=1,at=x,labels=MPNamesSub_legtext,las=2)
  }
  if(i%in%leftPanels){
    y.at.i <- y.at
    if(i>leftPanels[1]){y.at.i <- y.at[1:(length(y.at)-1)]}
    axis(side=2,at=y.at.i)
  }
}  

# if(i==legend_panel){
#    legend(legend_x,
#           inset=legend_inset,
#        horiz=TRUE,bty="n",
#        legend=MPNamesSub_legtext[legtext_o],
#        col=cols[legtext_o],lty=ltys[legtext_o],lwd=lwds[legtext_o],
#        cex=legend_cex,
#        xpd=NA
#        ) 
# 
# }
}

mtext(ylabel,side=2,line=1.5,outer=TRUE)
mtext(xlabel,side=1,line=xlabel_line,outer=TRUE)


}
```

```{r plot_MSE_sims function}
plot_MSE_sims <- function(MSE, sims=NULL, MPs=NULL, proyears_ix=NULL,
              varNames=NULL, rec_age=0,
              type="proj", # period to plot: "proj", or "histproj"
              title_main = NULL,
              vline=NULL,vline_lty=3,
              ...){
MSEName <- deparse(substitute(MSE))
if(is.null(varNames)){
  varNames <- list("proj"=    c("Catch","FM","F_FMSY","recruit","SSB","SB_SBMSY"),
                   "histproj"=c("Catch","FM","F_FMSY","recruit","SSB","SB_SBMSY"))[[type]]
}
  
nyears <- MSE@nyears
proyears <- MSE@proyears
LHyear <- MSE@Hist@Data@LHYear # Last historic year
histYears <- sort(LHyear - ((1:nyears)-1))
projYears <- LHyear+1:proyears

if(is.null(sims)){sims <- 1:3}  
if(is.null(MPs)){MPs <- MSE@MPs[1]}
if(is.null(proyears_ix))    {proyears_ix <- 1:proyears} 

MPn <- match(MPs,MSE@MPs)
  
nr <- ceiling(sqrt(length(varNames)))
nc <- ceiling(length(varNames)/nr)
par(mfcol=c(nr,nc),mar=c(2,3,1,1),oma=c(0,0,2,0),mgp=c(1,0.2,0),tck=-0.01)

for(varName_i in varNames){
  for(MPn_j in  MPn){
    MPn_j_ix <- match(MPn_j,MPn)
    if(type=="proj"){
      years_plot <- projYears
      if(varName_i=="recruit"){
        N <- Reduce("+",apply(MSE@Misc$extended$N,5,FUN=function(x){x},simplify = FALSE))
        var_i <- N[,rec_age+1,,]
        years_ix <-   tail(1:dim(var_i)[3],MSE@proyears)
        # drop MP dimension but not sims
        varSub_i <- var_i[sims,MPn_j,years_ix,drop=FALSE]
        varSub_i <- matrix(varSub_i,nrow=dim(varSub_i)[1],ncol=dim(varSub_i)[3]) 
      }else{
        var_i <- slot(MSE,varName_i)
        varSub_i <- var_i[sims,MPn_j,proyears_ix,drop=FALSE]
        varSub_i <- matrix(varSub_i,nrow=dim(varSub_i)[1],ncol=dim(varSub_i)[3]) 
      }
    }
    
    if(type=="histproj"){
      years_plot <- c(histYears, projYears)
      if(varName_i=="recruit"){
        N <- Reduce("+",apply(MSE@Misc$extended$N,5,FUN=function(x){x},simplify = FALSE))
        var_i <- N[,rec_age+1,,]
      }
      if(varName_i%in%c("F","FM")){
        FM <- apply(MSE@Misc$extended[["FM"]],c(1,3,4),max) # Max F over ages and areas
        var_i <- FM
      }
      if(varName_i=="F_FMSY"){
        FM <- apply(MSE@Misc$extended[["FM"]],c(1,3,4),max) # Max F over ages and areas
        FMSY <- MSE@RefPoint$FMSY
        var_i <- FM/FMSY
      }
      if(varName_i=="SB_SBMSY"){
        SSB <- apply(MSE@Misc$extended[["SSB"]],c(1,3,4),sum) # Sum SSB over ages and areas
        SSBMSY <- MSE@RefPoint$SSBMSY
        var_i <- SSB/SSBMSY
      }
      if(!varName_i%in%c("F","FM","recruit","F_FMSY","SB_SBMSY")){
        var_i <- Reduce("+",apply(MSE@Misc$extended[[varName_i]],5,FUN=function(x){x},simplify = FALSE))
        var_i <- Reduce("+",apply(var_i,2,FUN=function(x){x},simplify = FALSE))
      }
      #varSub_i <- var_i[sims,MPn_j,] # Drops dimension to be matrix
        varSub_i <- var_i[sims,MPn_j,,drop=FALSE]
        varSub_i <- matrix(varSub_i,nrow=dim(varSub_i)[1],ncol=dim(varSub_i)[3]) 
    }
    if(match(MPn_j,MPn)==1){
      matplot(years_plot,t(varSub_i),type="l",
              col=ROGBP(length(sims)),xlab="",ylab=varName_i, lty=MPn_j_ix,...)
    }else{
      matpoints(years_plot,t(varSub_i),type="l",
                col=ROGBP(length(sims)),lty=MPn_j_ix,...)
    }    
  }
  if(match(varName_i,varNames)==1){
    legend("topright",legend=MPs,lty=1:length(MPs),bty="n")
  }
  if(is.null(vline)){vline <- LHyear}
  abline(v=vline,lty=vline_lty)
}
if(is.null(title_main)){
  title_main <- paste(MSEName,MPs,sep=": ")
}
title(main=title_main,outer = TRUE)
}

```

```{r function PMsummary}

## NEED TO MODIFY THIS SO IT GROUPS THE GROUPED BOXPLOTS VISUALLY
# compute and plot summary statistics for Performance metrics
PMsummary <- function(PMName,
                      OMNames = OMNames_user,
                      scenNames,
                      MPs = NULL,
                      xaxis_label = NULL,
                      xaxis_label_outer = "Management procedure",
                      slot_to_plot = "Prob", # Can be either "Prob" or "Stat"
                      main_line = -1.5,
                      hline = 1,
                      hline_lty = 1,
                      par_args = list(mfrow = c(length(OMNames),1), mar = c(0,2,0,1), 
                                      oma = c(3,2,1,0), mgp = c(0.8,0.2,0), tck = -0.01),
                      n_yr_groups = 1, # Number of groups to split years into
                      group_space = NULL,  # Additional spacing between groups of boxes
                      ...){
  PM <- get(PMName)
  dots <- list(...)
  if(!"ylab"%in%names(dots)){
    dots$ylab <- PMName
  }
  if(!"col"%in%names(dots)){
    colorFUN = colorRampPalette(c("lightblue","darkblue"))
    dots$col <-  colorFUN(n_yr_groups)
  }
  if(is.null(group_space)){
    group_space <- (n_yr_groups-1)*.75
  }
  
  out_list <- list()
  
  do.call(par,par_args)
  
  for (OMNames_i in OMNames){
    Names_i <- gsub("^OM_","",OMNames_i)
    MSEoutNames_i = paste0(rep(gsub("OM","MSE",OMNames_i),each=length(scenNames)),
                           "_",
                           rep(scenNames,length(OMNames_i))
    )
    out_list_i <- list()
    for(MSEoutNames_ij in MSEoutNames_i){
      scenNames_j <- str_extract(MSEoutNames_ij,"[a-z]+$")
      MSEout_ij <- get(MSEoutNames_ij)
      proyears_ij <- MSEout_ij@proyears
      yr_ij <- 1:proyears_ij
      breaks_ij <- round(seq(min(yr_ij),max(yr_ij),length=n_yr_groups+1))
      
      yr_groups_ij <- as.numeric(cut(yr_ij,breaks=breaks_ij,include.lowest = TRUE))
      
      for(k in 1:n_yr_groups){
        MSEoutNames_ijk <- paste(MSEoutNames_ij,sprintf("%02.0f",k),sep="_")  
        PMout_ijk <- PM(MSEout_ij,Yrs=range(yr_ij[yr_groups_ij==k]))
        MPs_ijk <- PMout_ijk@MPs
        out_ijk <- slot(PMout_ijk,slot_to_plot)
        if(!is.null(MPs)){ # Possibly subset MPs
          out_ijk <- out_ijk[,match(MPs,MPs_ijk)]
          MPs_ijk <- MPs
        }
        dimnames(out_ijk) <- list("sim"=seq(1:dim(out_ijk)[1]), "MPs"=MPs_ijk)
        out_ijk <- cbind("scen"=scenNames_j,"yr_group"=k,as.data.frame(out_ijk))
        out_list_i[[MSEoutNames_ijk]] <- out_ijk
        
      } # end n_yr_groups
    } 
    # Combine scenario outputs into large data frame with scen column indicating scenario
    out_df_i <- do.call(rbind,out_list_i)
    out_df_i <- reshape2::melt(data=out_df_i,id.vars=c("scen","yr_group"))
    out_list[[paste0("out_df_",Names_i,"_",PMName)]] <- out_df_i
    
    # Plot stuff
    dots$xaxt <- ifelse(match(OMNames_i,rev(OMNames))==1,"n","n")
    n_group <- length(unique(out_df_i$yr_group))
    n_variable <- length(unique(out_df_i$variable))
    
    group_space_add <- rep(1:n_variable,each=n_group)*group_space
    box_at <- 1:(n_group*n_variable)+group_space_add
    
    xaxis_label_at <- apply(matrix(box_at,nrow=n_group,ncol=n_variable),2,mean)
    
    do.call(boxplot,c(list(formula = value ~ yr_group + variable, data = out_df_i,
                           main = "", at = box_at),dots))
    
    
    mtext(Names_i,side=3,line=main_line,outer=FALSE,font=2)
    abline(h=hline,lty=hline_lty)
  }
  if(is.null(xaxis_label)){xaxis_label <- MPs}
  
  axis(side = 1, at = xaxis_label_at, labels = xaxis_label)
  mtext(xaxis_label_outer,side=1,line=1.5, outer=TRUE,font=2)
  
  invisible(out_list)
}
```

```{r function MSEsummary}
# compute and plot summary statistics for Performance metrics
MSEsummary <- function(MSEslotName,
                       OMNames=OMNames_user,
                       scenNames,
                       MPs=NULL,
                       xaxis_label = NULL,
                       xaxis_label_outer = "Management procedure",
                       main_line=-1.5,
                       hline=1,
                       hline_lty=1,
                      par_args=list(mfrow=c(length(OMNames),1), 
                                    mar=c(0,2,0,1), oma=c(3,2,1,0),
                                    mgp=c(0.8,0.2,0), tck=-0.01),
                      n_yr_groups=1, # Number of groups to split years into
                      FUN_yr_groups=NULL,
                      group_space = NULL,  # Additional spacing between groups of boxes
                      ...){
dots <- list(...)
if(!"ylab"%in%names(dots)){
  dots$ylab <- MSEslotName
}
if(!"col"%in%names(dots)){
 colorFUN = colorRampPalette(c("lightblue","darkblue"))
 dots$col <-  colorFUN(n_yr_groups)
}
if(is.null(group_space)){
  group_space <- (n_yr_groups-1)*.75
}

out_list <- list()

do.call(par,par_args)

for (OMNames_i in OMNames){
  Names_i <- gsub("^OM_","",OMNames_i)
  MSEoutNames_i = paste0(rep(gsub("OM","MSE",OMNames_i),each=length(scenNames)),
                         "_",
                         rep(scenNames,length(OMNames_i))
  )
  slot_list_i <- list()
  for(MSEoutNames_ij in MSEoutNames_i){
    scenNames_j <- str_extract(MSEoutNames_ij,"[a-z]+$")
    MSEout_ij <- get(MSEoutNames_ij)
    MPs_ij <- MSEout_ij@MPs
    proyears_ij <- MSEout_ij@proyears
    yr_ij <- 1:proyears_ij
    breaks_ij <- round(seq(min(yr_ij),max(yr_ij),length=n_yr_groups+1))
      
    yr_groups_ij <- as.numeric(cut(yr_ij,breaks=breaks_ij,include.lowest = TRUE))
    
    if(!is.expression(MSEslotName)){
      slot_k <- slot(MSEout_ij,MSEslotName)
    }else{
      slot_k <- eval(MSEslotName)
    }
    list_slot_km <- list()
    for(m in 1:n_yr_groups){
      if(is.null(FUN_yr_groups)){
      slot_km <- slot_k[,,which(yr_groups_ij==m)] %>% apply(2,as.numeric)
      }else{
      slot_km <- slot_k[,,which(yr_groups_ij==m)] %>% apply(1:2,FUN_yr_groups)
      }
    if(!is.null(MPs)){
      slot_km <- slot_km[,match(MPs,MPs_ij)]
      MPs_ij <- MPs
    }
      dimnames(slot_km) <- list(NULL, "MPs"=MPs_ij)
      list_slot_km[[m]] <- cbind("yr_group"=m,as.data.frame(slot_km))
    }
    
    slot_df_km <- do.call(rbind,list_slot_km)
    

    slot_df_km <- cbind("scen"=scenNames_j,as.data.frame(slot_df_km))
    slot_list_i[[MSEoutNames_ij]] <- slot_df_km
    
  }
  # Combine scenario outputs into large data frame with scen column indicating scenario
  slot_df_i <- do.call(rbind,slot_list_i)
  slot_df_i <- reshape2::melt(data=slot_df_i,id.vars=c("scen","yr_group"))
  out_list[[paste0("slot_df_",Names_i,"_",MSEslotName)]] <- slot_df_i
  
  # Plot stuff
  dots$xaxt <- ifelse(match(OMNames_i,rev(OMNames))==1,"n","n")
  n_group <- length(unique(slot_df_i$yr_group))
  n_variable <- length(unique(slot_df_i$variable))
      
  group_space_add <- rep(1:n_variable,each=n_group)*group_space
  box_at <- 1:(n_group*n_variable)+group_space_add
  
  xaxis_label_at <- apply(matrix(box_at,nrow=n_group,ncol=n_variable),2,mean)
      
  do.call(boxplot,c(list(formula=value~yr_group+variable,data=slot_df_i,main="",at=box_at),dots))
  mtext(Names_i,side=3,line=main_line,outer=FALSE,font=2)
  abline(h=hline,lty=hline_lty)
}
  if(is.null(xaxis_label)){xaxis_label <- MPs}
  
  axis(side = 1, at = xaxis_label_at, labels = xaxis_label)
  mtext(xaxis_label_outer,side=1,line=1.5, outer=TRUE,font=2)

invisible(out_list)
}
```

```{r data}
# Read in data for original operating models
for(file.i in list.files("OM")){
  assign(gsub(".rds","",file.i),readRDS(file.path("OM",file.i)))
}

# Read in data for modified operating models
# for(file.i in list.files("OM_modified")){
#   assign(gsub(".rds","",file.i),readRDS(file.path("OM_modified",file.i)))
# }

if(is.null(OMNames_user)){
OMNames <- gsub(".rds","",list.files("OM"))
}else{
OMNames <- OMNames_user
}

# Read in MSE results
MSE_res_names <- gsub(".rds","",list.files("MSE_obj"))
#MSE_res_names <- gsub(".rds","",list.files("MSE_obj")[grepl("OM_",list.files("MSE_obj"))])
for(file.i in list.files("MSE_obj")){
  if(file.i%in%paste0("MSE_",rep(Names_user,each=length(scenNames_user)),"_",scenNames_user,".rds")){
    
    out_i <- readRDS(file.path("MSE_obj",file.i))
    names(out_i@PPD) <- out_i@MPs
    assign(gsub(".rds","",file.i),readRDS(file.path("MSE_obj",file.i)))
    rm(out_i)
  }
}
```

```{r OMNames set 1,eval=TRUE}
OMNames <- OMNames_user#[1:3]
speciesNames <- gsub("OM_","",OMNames)
speciesNames_huynh <- gsub("OM_","",OMNames_huynh)
MSEoutNames_user1 <- paste0(rep(gsub("OM","MSE",OMNames),each=length(scenNames_user1)),
                     "_",
                     rep(scenNames_user1,length(OMNames))
                     )

```

```{r plot data1, fig.cap=paste0("\\label{fig:lifeHist} Life history (growth and maturity) and vulnerability schedules at age used in the operating models during the projection period ",combine_words(speciesNames),". Growth is expressed as mean length-at-age relative to that at the maximum age."),eval=TRUE}
# Figure 1 from Huynh et al (2020)

par(mfrow=c(length(OMNames),1),mgp=c(1,0.2,0),mar=c(1.5,2,1.5,1),oma=c(1,2,1,1),tck=-0.01)
for(OM_Name_i in OMNames){
i <- which(OMNames==OM_Name_i)  
OM_i <- get(OM_Name_i)
speciesName_i <- gsub("OM_","",OM_Name_i)
plot_LH(OM_i,xlab="",ylab="",main=speciesName_i)
if(i==1){
  legend("bottomright",legend=c("Rel. length","Maturity","Vulnerability"),lwd=c(3,3,3),lty=c(1,2,3),bty="n")
}
if(i==length(OMNames)){
  mtext("Value",2,0,outer = TRUE)
}
}
```

```{r plot selectivities,fig.cap=paste0("\\label{fig:selex} Vulnerability schedules at age used in the operating models during the historical period (colored lines in rainbow order) and projection period (black lines)",combine_words(speciesNames),". Growth is expressed as mean length-at-age relative to that at the maximum age.")} 
par(mfrow=c(length(OMNames),1),mgp=c(1,0.2,0),mar=c(3,2,1.5,1),oma=c(1,2,1,1),tck=-0.01)
for(OMName_i in OMNames){#paste0(OMNames,"_base")){
OM_i <- get(OMName_i)
V_i <- OM_i@cpars$V
nyears_i <- OM_i@nyears
proyears_i <- OM_i@proyears
cols_i <- rainbow(nyears_i)
matplot(V_i[1,,1:nyears_i],type="l",lty=1,col=cols_i,main=OMName_i,xlab="age",ylab="V")
matpoints(V_i[1,,nyears_i+(1:proyears_i)],type="l",lty=1,col="black",lwd=2)
}

```

```{r plot selectivities huynh,fig.cap=paste0("\\label{fig:selexhuynh} Vulnerability schedules at age used in the operating models during the historical period (colored lines in rainbow order) and projection period (black lines)",combine_words(speciesNames_huynh),". Growth is expressed as mean length-at-age relative to that at the maximum age."),eval=FALSE} 
par(mfrow=c(length(OMNames_huynh),1),mgp=c(1,0.2,0),mar=c(3,2,1.5,1),oma=c(1,2,1,1),tck=-0.01)
for(OMName_i in OMNames_huynh){
OM_i <- get(OMName_i)
V_i <- OM_i@cpars$V
nyears_i <- OM_i@nyears
proyears_i <- OM_i@proyears
cols_i <- rainbow(nyears_i)
matplot(V_i[1,,1:nyears_i],type="l",lty=1,col=cols_i,main=OMName_i,xlab="age",ylab="V")
matpoints(V_i[1,,nyears_i+(1:proyears_i)],type="l",lty=1,col="black",lwd=2)
}

```

```{r plot Ind, eval=FALSE}
# This code is set up to make each set of plots for each MP, but the indices are basically the same

for(MP_name_i in "SCA_5"){#MPNamesAll[1]){
    # Ind
    plot_MSE_ts(
      OMNames= OMNames, scenNames=scenNames_user1,
      myvarName = expression(slot(out_i@PPD[[MP_name_i]],"Ind")),
      plot_type = "boot",
      FUN = mean_noNA,
      ylabel = "index of abundance",
      MPNamesSub = MPNamesSub_user,
      MPNamesSub_legtext=MPNamesSub_user_legtext,
      rowLabs=scenNames_key[scenNames_user1],
      oma=c(3,4,5,3),
      ylim=c(0,4)
    )
  title(main=MP_name_i,outer=TRUE)
}
```

```{r plot AddInd, eval=TRUE}
# This code is set up to make each set of plots for each MP, but the indices are basically the same
if(plot_pdf){pdf("Figs/AddInd.pdf")}
for(MP_name_i in "SCA_10"){#MPNamesAll){
    # Ind
    # MSE_i <- get(MSE_name_j)
    plot_MSE_ts(
      OMNames= OMNames, scenNames="base",
      myvarName = expression(slot(out_i@PPD[[MP_name_i]],"AddInd")),
      plot_type = "addind",
      ylabel = "index of abundance",
      # FUN=mean_noNA,
      MPNamesSub = MP_name_i,
      # MPNamesSub_legtext=MPNamesSub_user_legtext,
      #rowLabs=scenNames_key["addind"],
      xlabel="year",
      oma=c(3,4,5,3),
      ylim=c(0,8),
      main_line = -1.5,
      hline=NA
    )
  #title(main=MP_name_i,outer=TRUE)
}
if(plot_pdf){dev.off()}
```

```{r plot sims proj base, eval=FALSE}
MPs_sim <- c("SCA_1","SCA_10","iMP_avg_10")
scen <- "base"

for(OMName_i in OMNames_user){
Name_i <- gsub("^OM_","",OMName_i)
MSEoutName_i <- paste0(gsub("^OM","MSE",OMName_i),paste0("_",scen))
MSEOut_i <- get(MSEoutName_i)

figName_ij <- paste0("sims",gsub("MSE|_","",MSEoutName_i),".pdf")
if(plot_pdf){pdf(file.path("Figs",figName_ij))}
plot_MSE_sims(MSEOut_i,MPs=MPs_sim,type="proj",
              lwd=2,sims=sample(1,1:50),
              title_main = paste0(Name_i,", ",scen),
              varNames = c("Catch","TAC","FM","F_FMSY",#"recruit",
                           "SSB","SB_SBMSY"))
if(plot_pdf){dev.off()}
}

```

```{r plot sims base}
MPs_sim <- c("SCA_1","SCA_10","iMP_avg_10")
scen <- "base"

for(OMName_i in OMNames_user){
Name_i <- gsub("^OM_","",OMName_i)
MSEoutName_i <- paste0(gsub("^OM","MSE",OMName_i),paste0("_",scen))
MSEOut_i <- get(MSEoutName_i)

figName_ij <- paste0("sims",gsub("MSE|_","",MSEoutName_i),".pdf")
if(plot_pdf){pdf(file.path("Figs",figName_ij))}
plot_MSE_sims(MSEOut_i,MPs=MPs_sim,type="histproj",
              lwd=2,sims=sample(1,1:50),
              title_main = paste0(Name_i,", ",scen))
if(plot_pdf){dev.off()}
}

```

```{r plot sims minerr, eval=FALSE}
MPs_sim <- c("SCA_1","SCA_10","iMP_avg_10")
scen <- "minerr"

for(OMName_i in OMNames_user){
Name_i <- gsub("^OM_","",OMName_i)
MSEoutName_i <- paste0(gsub("^OM","MSE",OMName_i),paste0("_",scen))
MSEOut_i <- get(MSEoutName_i)

figName_ij <- paste0("sims",gsub("MSE|_","",MSEoutName_i),".pdf")
if(plot_pdf){pdf(file.path("Figs",figName_ij))}
plot_MSE_sims(MSEOut_i,MPs=MPs_sim,type="histproj",
              lwd=2,sims=1,
              title_main = paste0(Name_i,", ",scen))
if(plot_pdf){dev.off()}
}
```

```{r plot sims minrecdev, eval=FALSE}
MPs_sim <- c("SCA_1","SCA_10","iMP_avg_10")
scen <- "minrecdev"

for(OMName_i in OMNames_user){
Name_i <- gsub("^OM_","",OMName_i)
MSEoutName_i <- paste0(gsub("^OM","MSE",OMName_i),paste0("_",scen))
MSEOut_i <- get(MSEoutName_i)

figName_ij <- paste0("sims",gsub("MSE|_","",MSEoutName_i),".pdf")
if(plot_pdf){pdf(file.path("Figs",figName_ij))}
plot_MSE_sims(MSEOut_i,MPs=MPs_sim,type="histproj",
              lwd=2,sims=1,
              title_main = paste0(Name_i,", ",scen))
if(plot_pdf){dev.off()}
}

# Check if assessments are converging and hessians inverting
# unlist(lapply(MSE_BlackSeaBass_minrecdev@PPD$SCA_1@Misc,function(i){table(unlist(lapply(i$diagnostic,function(j){j$hess})))}))
```

```{r plot sims perfobs, eval=FALSE}
MPs_sim <- c("SCA_1","SCA_10","iMP_avg_10")
scen <- "perfobs"

for(OMName_i in OMNames_user){
Name_i <- gsub("^OM_","",OMName_i)
MSEoutName_i <- paste0(gsub("^OM","MSE",OMName_i),paste0("_",scen))
MSEOut_i <- get(MSEoutName_i)

figName_ij <- paste0("sims",gsub("MSE|_","",MSEoutName_i),".pdf")
if(plot_pdf){pdf(file.path("Figs",figName_ij))}
plot_MSE_sims(MSEOut_i,MPs=MPs_sim,type="histproj",
              lwd=2,sims=1,
              title_main = paste0(Name_i,", ",scen))
if(plot_pdf){dev.off()}
}

```

```{r plot sims "vtiv",eval=FALSE}
MPs_sim <- c("SCA_1","SCA_10","iMP_avg_10")
scen <- "vtiv"

for(OMName_i in OMNames_user){
Name_i <- gsub("^OM_","",OMName_i)
MSEoutName_i <- paste0(gsub("^OM","MSE",OMName_i),paste0("_",scen))
MSEOut_i <- get(MSEoutName_i)

figName_ij <- paste0("sims",gsub("MSE|_","",MSEoutName_i),".pdf")
if(plot_pdf){pdf(file.path("Figs",figName_ij))}
plot_MSE_sims(MSEOut_i,MPs=MPs_sim,type="histproj",
              lwd=2,sims=1,
              title_main = paste0(Name_i,", ",scen))
if(plot_pdf){dev.off()}
}

```


```{r summary plots, eval=TRUE}
# Summary plots combining all years and all scenarios

if(plot_pdf){pdf("Figs/boxplotPBgrt75BMSY1.pdf")}
P75_out <- PMsummary("P75",scenNames=scenNames_user1,MPs=MPNamesAll,
                     cex.axis=1,las=2,outline=FALSE,
                     boxwex=0.5,ylab="",ylim=c(0,1.1),
                     hline=NA,n_yr_groups=3,
                     xaxis_label=gsub("buffer","bfr",MPNamesAll)
                     )       
mtext("P(B > 0.75 BMSY)",side = 2,outer=TRUE,font=2)
if(plot_pdf){dev.off()}

if(plot_pdf){pdf("Figs/boxplotPBgrtBMSY1.pdf")}
P100_out <- PMsummary("P100",scenNames=scenNames_user1,MPs=MPNamesAll,
                     cex.axis=1,las=2,outline=FALSE,
                     boxwex=0.5,ylab="",ylim=c(0,1.1),
                     hline=NA,n_yr_groups=3,
                     xaxis_label=gsub("buffer","bfr",MPNamesAll)
                     )
mtext("P(B > BMSY)",2,outer=TRUE,font=2)
if(plot_pdf){dev.off()}

if(plot_pdf){pdf("Figs/boxplotPFlssFMSY1.pdf")}
PNOF_out <- PMsummary("PNOF",scenNames=scenNames_user1,MPs=MPNamesAll,
                     cex.axis=1,las=2,outline=FALSE,
                     boxwex=0.5,ylab="",ylim=c(0,1.1),
                     hline=NA,n_yr_groups=3,
                     xaxis_label=gsub("buffer","bfr",MPNamesAll)
                     )
mtext("P(F < FMSY)",2,outer=TRUE,font=2)
if(plot_pdf){dev.off()}

if(plot_pdf){pdf("Figs/boxplotAAVY1.pdf")}
AAVY_out <- PMsummary("AAVY",scenNames=scenNames_user1,MPs=MPNamesAll,
                     slot_to_plot = "Stat",
                     cex.axis=1,las=2,outline=FALSE,
                     boxwex=0.5,ylab="",ylim=c(0,1.1),
                     hline=0.2,n_yr_groups=3,
                     xaxis_label=gsub("buffer","bfr",MPNamesAll)
                     )   
mtext("Avg. Annual Variability in Yield",2,outer=TRUE,font=2)
if(plot_pdf){dev.off()}

if(plot_pdf){pdf("Figs/boxplotSBSBMSY1.pdf")}
MSEsummary("SB_SBMSY",scenNames=scenNames_user1,MPs=MPNamesAll,
           cex.axis=0.75,las=2,outline=FALSE,boxwex=0.5,ylab="",
           n_yr_groups=3,hline=1,
           xaxis_label=gsub("buffer","bfr",MPNamesAll)
)
mtext("SSB/SSBmsy",2,outer=TRUE,font=2)
if(plot_pdf){dev.off()}

if(plot_pdf){pdf("Figs/boxplotFFMSY1.pdf")}
MSEsummary("F_FMSY",scenNames=scenNames_user1,MPs=MPNamesAll,
           cex.axis=0.75,las=2,outline=FALSE,boxwex=0.5,ylab="",
           n_yr_groups=3,hline=1,
           xaxis_label=gsub("buffer","bfr",MPNamesAll)
)
mtext("F/Fmsy",2,outer=TRUE,font=2)
if(plot_pdf){dev.off()}

if(plot_pdf){pdf("Figs/boxplotCatch1.pdf")}
MSEsummary("Catch",scenNames=scenNames_user1,MPs=MPNamesAll,
           cex.axis=0.75,las=2,outline=FALSE,boxwex=0.5,ylab="",
           n_yr_groups=3,
           xaxis_label=gsub("buffer","bfr",MPNamesAll)
)
mtext("Catch",2,outer=TRUE,font=2)
if(plot_pdf){dev.off()}

if(plot_pdf){pdf("Figs/boxplotCatchTotal1.pdf")}
MSEsummary("Catch",scenNames=scenNames_user1,MPs=MPNamesAll,
           cex.axis=0.75,las=2,outline=FALSE,boxwex=0.5,ylab="",
           n_yr_groups=3,FUN_yr_groups=sum,
           xaxis_label=gsub("buffer","bfr",MPNamesAll)
)
mtext("Total catch",2,outer=TRUE,font=2)
if(plot_pdf){dev.off()}



## Which is the best MP?

### Highest yield

### Most consistent yield

### Lowest probability of overfishing
```

```{r plot time series1,eval=TRUE}
# # VB
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user1,
# myvarName = "VB",
# ylabel = expression(mean~(VB)),
# FUN = mean,
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user1]
# )

# SSB
if(plot_pdf){pdf("Figs/tsSSB1.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user1,
  myvarName = "SSB",
  ylabel = expression(mean~(SSB)),
  FUN = mean,
  MPNamesSub = MPNamesSub_user,
  MPNamesSub_legtext=MPNamesSub_user_legtext,
  rowLabs=scenNames_key[scenNames_user1]
)
if(plot_pdf){dev.off()}
# 
# # F
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user1,  
# myvarName = "FM",
# ylabel = expression(mean~(F)),
# FUN = mean,
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user1]
# )
# 
# # TAC
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user1,  
# myvarName = "TAC",
# ylabel = expression(mean~(TAC)),
# FUN = mean,
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user1] 
# )

# Catch
if(plot_pdf){pdf("Figs/tsCatch1.pdf")}
plot_MSE_ts(
OMNames= OMNames, scenNames=scenNames_user1,  
myvarName = "Catch",
ylabel = expression(mean~(Catch)),
FUN = mean,
MPNamesSub = MPNamesSub_user,
MPNamesSub_legtext=MPNamesSub_user_legtext,
rowLabs=scenNames_key[scenNames_user1]
)
if(plot_pdf){dev.off()}

# SSB/SSBmsy
if(plot_pdf){pdf("Figs/tsSSBSSBmsy1.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user1,
  myvarName = "SB_SBMSY",
  ylabel = expression(mean~(SSB/SSBmsy)),
  FUN = mean,
  ylim=c(0,2),
  MPNamesSub = MPNamesSub_user,
  MPNamesSub_legtext=MPNamesSub_user_legtext,
  rowLabs=scenNames_key[scenNames_user1],
  hline=1
)
if(plot_pdf){dev.off()}

# F/Fmsy
if(plot_pdf){pdf("Figs/tsFFmsy1.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user1,
  myvarName = "F_FMSY",
  ylabel = expression(mean~(F/Fmsy)),
  FUN = mean,
  ylim=c(0,2),
  MPNamesSub = MPNamesSub_user,
  MPNamesSub_legtext=MPNamesSub_user_legtext,
  rowLabs=scenNames_key[scenNames_user1],
  hline=1
)
if(plot_pdf){dev.off()}

# C/MSY
if(plot_pdf){pdf("Figs/tsCatchMSY1.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user1,
  myvarName = "Catch",
  myvarDenomExpr = expression(slot(out_i,"RefPoint")$MSY[,,-(1:out_i@nyears)]),
  ylabel = expression(mean~(Catch/MSY)),
  FUN = mean,
  ylim=c(0,2),
  MPNamesSub = MPNamesSub_user,
  MPNamesSub_legtext=MPNamesSub_user_legtext,
  rowLabs=scenNames_key[scenNames_user1],
  hline=1
)
if(plot_pdf){dev.off()}

# 
# # TAC/MSY
# plot_MSE_ts(
#   OMNames= OMNames, scenNames=scenNames_user1,
#   myvarName = "TAC",
#   myvarDenomExpr = expression(slot(out_i,"RefPoint")$MSY[,,-(1:out_i@nyears)]),
#   ylabel = expression(mean~(TAC/MSY)),
#   FUN = mean,
#   ylim=c(0,2),
#   MPNamesSub = MPNamesSub_user,
#   MPNamesSub_legtext=MPNamesSub_user_legtext,
#   rowLabs=scenNames_key[scenNames_user1]
# )
# 
# # C/TAC
# plot_MSE_ts(
#   OMNames= OMNames, scenNames=scenNames_user1,  
#   myvarName = "Catch",
#   myvarDenomExpr = expression(slot(out_i,"TAC")),
#   ylabel = expression(mean~(C/TAC)),
#   FUN = mean,
#   ylim=c(0,1.1),
#   MPNamesSub = MPNamesSub_user,
#   MPNamesSub_legtext=MPNamesSub_user_legtext,
#   rowLabs=scenNames_key[scenNames_user1]
# )
# 
# # MSY
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user1,
# myvarName = expression(slot(out_i,"RefPoint")$MSY[,,-(1:out_i@nyears)]),
# FUN = mean,
# ylabel= expression(mean~(MSY)),
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user1]
# )
# 
# # SSBMSY
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user1,
# myvarName = expression(slot(out_i,"RefPoint")$SSBMSY[,,-(1:out_i@nyears)]),
# FUN = mean,
# ylabel= expression(mean~(SSBMSY)),
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user1]
# )
# 
# # FMSY
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user1,
# myvarName = expression(slot(out_i,"RefPoint")$FMSY[,,-(1:out_i@nyears)]),
# FUN = mean,
# ylabel= expression(mean~(FMSY)),
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user1]
# )
# 
# # UMSY
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user1,
# myvarName = expression(F2U(slot(out_i,"RefPoint")$FMSY[,,-(1:out_i@nyears)])),
# FUN = mean,
# ylabel= expression(mean~(UMSY)),
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user1]
# )
```

```{r plot time series2,eval=TRUE}
# # VB
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user2,
# myvarName = "VB",
# ylabel = expression(mean~(VB)),
# FUN = mean,
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user2]
# )

# SSB
if(plot_pdf){pdf("Figs/tsSSB2.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user2,
  myvarName = "SSB",
  ylabel = expression(mean~(SSB)),
  FUN = mean,
  MPNamesSub = MPNamesSub_user,
  MPNamesSub_legtext=MPNamesSub_user_legtext,
  rowLabs=scenNames_key[scenNames_user2]
)
if(plot_pdf){dev.off()}
# 
# # F
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user2,  
# myvarName = "FM",
# ylabel = expression(mean~(F)),
# FUN = mean,
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user2]
# )
# 
# # TAC
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user2,  
# myvarName = "TAC",
# ylabel = expression(mean~(TAC)),
# FUN = mean,
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user2] 
# )

# Catch
if(plot_pdf){pdf("Figs/tsCatch2.pdf")}
plot_MSE_ts(
OMNames= OMNames, scenNames=scenNames_user2,  
myvarName = "Catch",
ylabel = expression(mean~(Catch)),
FUN = mean,
MPNamesSub = MPNamesSub_user,
MPNamesSub_legtext=MPNamesSub_user_legtext,
rowLabs=scenNames_key[scenNames_user2]
)
if(plot_pdf){dev.off()}

# SSB/SSBmsy
if(plot_pdf){pdf("Figs/tsSSBSSBmsy2.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user2,
  myvarName = "SB_SBMSY",
  ylabel = expression(mean~(SSB/SSBmsy)),
  FUN = mean,
  ylim=c(0,2),
  MPNamesSub = MPNamesSub_user,
  MPNamesSub_legtext=MPNamesSub_user_legtext,
  rowLabs=scenNames_key[scenNames_user2],
  hline=1
)
if(plot_pdf){dev.off()}

# F/Fmsy
if(plot_pdf){pdf("Figs/tsFFmsy2.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user2,
  myvarName = "F_FMSY",
  ylabel = expression(mean~(F/Fmsy)),
  FUN = mean,
  ylim=c(0,2),
  MPNamesSub = MPNamesSub_user,
  MPNamesSub_legtext=MPNamesSub_user_legtext,
  rowLabs=scenNames_key[scenNames_user2],
  hline=1
)
if(plot_pdf){dev.off()}

# C/MSY
if(plot_pdf){pdf("Figs/tsCatchMSY2.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user2,
  myvarName = "Catch",
  myvarDenomExpr = expression(slot(out_i,"RefPoint")$MSY[,,-(1:out_i@nyears)]),
  ylabel = expression(mean~(Catch/MSY)),
  FUN = mean,
  ylim=c(0,2),
  MPNamesSub = MPNamesSub_user,
  MPNamesSub_legtext=MPNamesSub_user_legtext,
  rowLabs=scenNames_key[scenNames_user2],
  hline=1
)
if(plot_pdf){dev.off()}

# 
# # TAC/MSY
# plot_MSE_ts(
#   OMNames= OMNames, scenNames=scenNames_user2,
#   myvarName = "TAC",
#   myvarDenomExpr = expression(slot(out_i,"RefPoint")$MSY[,,-(1:out_i@nyears)]),
#   ylabel = expression(mean~(TAC/MSY)),
#   FUN = mean,
#   ylim=c(0,2),
#   MPNamesSub = MPNamesSub_user,
#   MPNamesSub_legtext=MPNamesSub_user_legtext,
#   rowLabs=scenNames_key[scenNames_user2]
# )
# 
# # C/TAC
# plot_MSE_ts(
#   OMNames= OMNames, scenNames=scenNames_user2,  
#   myvarName = "Catch",
#   myvarDenomExpr = expression(slot(out_i,"TAC")),
#   ylabel = expression(mean~(C/TAC)),
#   FUN = mean,
#   ylim=c(0,1.1),
#   MPNamesSub = MPNamesSub_user,
#   MPNamesSub_legtext=MPNamesSub_user_legtext,
#   rowLabs=scenNames_key[scenNames_user2]
# )
# 
# # MSY
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user2,
# myvarName = expression(slot(out_i,"RefPoint")$MSY[,,-(1:out_i@nyears)]),
# FUN = mean,
# ylabel= expression(mean~(MSY)),
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user2]
# )
# 
# # SSBMSY
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user2,
# myvarName = expression(slot(out_i,"RefPoint")$SSBMSY[,,-(1:out_i@nyears)]),
# FUN = mean,
# ylabel= expression(mean~(SSBMSY)),
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user2]
# )
# 
# # FMSY
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user2,
# myvarName = expression(slot(out_i,"RefPoint")$FMSY[,,-(1:out_i@nyears)]),
# FUN = mean,
# ylabel= expression(mean~(FMSY)),
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user2]
# )
# 
# # UMSY
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user2,
# myvarName = expression(F2U(slot(out_i,"RefPoint")$FMSY[,,-(1:out_i@nyears)])),
# FUN = mean,
# ylabel= expression(mean~(UMSY)),
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user2]
# )
```

```{r plot time series3,eval=TRUE}
# # VB
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user3,
# myvarName = "VB",
# ylabel = expression(mean~(VB)),
# FUN = mean,
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user3]
# )

# SSB
if(plot_pdf){pdf("Figs/tsSSB3.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user3,
  myvarName = "SSB",
  ylabel = expression(mean~(SSB)),
  FUN = mean,
  MPNamesSub = MPNamesSub_user,
  MPNamesSub_legtext=MPNamesSub_user_legtext,
  rowLabs=scenNames_key[scenNames_user3]
)
if(plot_pdf){dev.off()}
# 
# # F
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user3,  
# myvarName = "FM",
# ylabel = expression(mean~(F)),
# FUN = mean,
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user3]
# )
# 
# # TAC
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user3,  
# myvarName = "TAC",
# ylabel = expression(mean~(TAC)),
# FUN = mean,
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user3] 
# )

# Catch
if(plot_pdf){pdf("Figs/tsCatch3.pdf")}
plot_MSE_ts(
OMNames= OMNames, scenNames=scenNames_user3,  
myvarName = "Catch",
ylabel = expression(mean~(Catch)),
FUN = mean,
MPNamesSub = MPNamesSub_user,
MPNamesSub_legtext=MPNamesSub_user_legtext,
rowLabs=scenNames_key[scenNames_user3]
)
if(plot_pdf){dev.off()}

# SSB/SSBmsy
if(plot_pdf){pdf("Figs/tsSSBSSBmsy3.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user3,
  myvarName = "SB_SBMSY",
  ylabel = expression(mean~(SSB/SSBmsy)),
  FUN = mean,
  ylim=c(0,2),
  MPNamesSub = MPNamesSub_user,
  MPNamesSub_legtext=MPNamesSub_user_legtext,
  rowLabs=scenNames_key[scenNames_user3],
  hline=1
)
if(plot_pdf){dev.off()}

# F/Fmsy
if(plot_pdf){pdf("Figs/tsFFmsy3.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user3,
  myvarName = "F_FMSY",
  ylabel = expression(mean~(F/Fmsy)),
  FUN = mean,
  ylim=c(0,2),
  MPNamesSub = MPNamesSub_user,
  MPNamesSub_legtext=MPNamesSub_user_legtext,
  rowLabs=scenNames_key[scenNames_user3],
  hline=1
)
if(plot_pdf){dev.off()}

# C/MSY
if(plot_pdf){pdf("Figs/tsCatchMSY3.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user3,
  myvarName = "Catch",
  myvarDenomExpr = expression(slot(out_i,"RefPoint")$MSY[,,-(1:out_i@nyears)]),
  ylabel = expression(mean~(Catch/MSY)),
  FUN = mean,
  ylim=c(0,2),
  MPNamesSub = MPNamesSub_user,
  MPNamesSub_legtext=MPNamesSub_user_legtext,
  rowLabs=scenNames_key[scenNames_user3],
  hline=1
)
if(plot_pdf){dev.off()}

# 
# # TAC/MSY
# plot_MSE_ts(
#   OMNames= OMNames, scenNames=scenNames_user3,
#   myvarName = "TAC",
#   myvarDenomExpr = expression(slot(out_i,"RefPoint")$MSY[,,-(1:out_i@nyears)]),
#   ylabel = expression(mean~(TAC/MSY)),
#   FUN = mean,
#   ylim=c(0,2),
#   MPNamesSub = MPNamesSub_user,
#   MPNamesSub_legtext=MPNamesSub_user_legtext,
#   rowLabs=scenNames_key[scenNames_user3]
# )
# 
# # C/TAC
# plot_MSE_ts(
#   OMNames= OMNames, scenNames=scenNames_user3,  
#   myvarName = "Catch",
#   myvarDenomExpr = expression(slot(out_i,"TAC")),
#   ylabel = expression(mean~(C/TAC)),
#   FUN = mean,
#   ylim=c(0,1.1),
#   MPNamesSub = MPNamesSub_user,
#   MPNamesSub_legtext=MPNamesSub_user_legtext,
#   rowLabs=scenNames_key[scenNames_user3]
# )
# 
# # MSY
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user3,
# myvarName = expression(slot(out_i,"RefPoint")$MSY[,,-(1:out_i@nyears)]),
# FUN = mean,
# ylabel= expression(mean~(MSY)),
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user3]
# )
# 
# # SSBMSY
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user3,
# myvarName = expression(slot(out_i,"RefPoint")$SSBMSY[,,-(1:out_i@nyears)]),
# FUN = mean,
# ylabel= expression(mean~(SSBMSY)),
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user3]
# )
# 
# # FMSY
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user3,
# myvarName = expression(slot(out_i,"RefPoint")$FMSY[,,-(1:out_i@nyears)]),
# FUN = mean,
# ylabel= expression(mean~(FMSY)),
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user3]
# )
# 
# # UMSY
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user3,
# myvarName = expression(F2U(slot(out_i,"RefPoint")$FMSY[,,-(1:out_i@nyears)])),
# FUN = mean,
# ylabel= expression(mean~(UMSY)),
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user3]
# )
```

```{r plot time series4,eval=TRUE}
# # VB
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user4,
# myvarName = "VB",
# ylabel = expression(mean~(VB)),
# FUN = mean,
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user4]
# )

# SSB
if(plot_pdf){pdf("Figs/tsSSB4.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user4,
  myvarName = "SSB",
  ylabel = expression(mean~(SSB)),
  FUN = mean,
  MPNamesSub = MPNamesSub_user,
  MPNamesSub_legtext=MPNamesSub_user_legtext,
  rowLabs=scenNames_key[scenNames_user4]
)
if(plot_pdf){dev.off()}
# 
# # F
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user4,  
# myvarName = "FM",
# ylabel = expression(mean~(F)),
# FUN = mean,
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user4]
# )
# 
# # TAC
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user4,  
# myvarName = "TAC",
# ylabel = expression(mean~(TAC)),
# FUN = mean,
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user4] 
# )

# Catch
if(plot_pdf){pdf("Figs/tsCatch4.pdf")}
plot_MSE_ts(
OMNames= OMNames, scenNames=scenNames_user4,  
myvarName = "Catch",
ylabel = expression(mean~(Catch)),
FUN = mean,
MPNamesSub = MPNamesSub_user,
MPNamesSub_legtext=MPNamesSub_user_legtext,
rowLabs=scenNames_key[scenNames_user4]
)
if(plot_pdf){dev.off()}

# SSB/SSBmsy
if(plot_pdf){pdf("Figs/tsSSBSSBmsy4.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user4,
  myvarName = "SB_SBMSY",
  ylabel = expression(mean~(SSB/SSBmsy)),
  FUN = mean,
  ylim=c(0,2),
  MPNamesSub = MPNamesSub_user,
  MPNamesSub_legtext=MPNamesSub_user_legtext,
  rowLabs=scenNames_key[scenNames_user4],
  hline=1
)
if(plot_pdf){dev.off()}

# F/Fmsy
if(plot_pdf){pdf("Figs/tsFFmsy4.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user4,
  myvarName = "F_FMSY",
  ylabel = expression(mean~(F/Fmsy)),
  FUN = mean,
  ylim=c(0,2),
  MPNamesSub = MPNamesSub_user,
  MPNamesSub_legtext=MPNamesSub_user_legtext,
  rowLabs=scenNames_key[scenNames_user4],
  hline=1
)
if(plot_pdf){dev.off()}

# C/MSY
if(plot_pdf){pdf("Figs/tsCatchMSY4.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user4,
  myvarName = "Catch",
  myvarDenomExpr = expression(slot(out_i,"RefPoint")$MSY[,,-(1:out_i@nyears)]),
  ylabel = expression(mean~(Catch/MSY)),
  FUN = mean,
  ylim=c(0,2),
  MPNamesSub = MPNamesSub_user,
  MPNamesSub_legtext=MPNamesSub_user_legtext,
  rowLabs=scenNames_key[scenNames_user4],
  hline=1
)
if(plot_pdf){dev.off()}

# 
# # TAC/MSY
# plot_MSE_ts(
#   OMNames= OMNames, scenNames=scenNames_user4,
#   myvarName = "TAC",
#   myvarDenomExpr = expression(slot(out_i,"RefPoint")$MSY[,,-(1:out_i@nyears)]),
#   ylabel = expression(mean~(TAC/MSY)),
#   FUN = mean,
#   ylim=c(0,2),
#   MPNamesSub = MPNamesSub_user,
#   MPNamesSub_legtext=MPNamesSub_user_legtext,
#   rowLabs=scenNames_key[scenNames_user4]
# )
# 
# # C/TAC
# plot_MSE_ts(
#   OMNames= OMNames, scenNames=scenNames_user4,  
#   myvarName = "Catch",
#   myvarDenomExpr = expression(slot(out_i,"TAC")),
#   ylabel = expression(mean~(C/TAC)),
#   FUN = mean,
#   ylim=c(0,1.1),
#   MPNamesSub = MPNamesSub_user,
#   MPNamesSub_legtext=MPNamesSub_user_legtext,
#   rowLabs=scenNames_key[scenNames_user4]
# )
# 
# # MSY
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user4,
# myvarName = expression(slot(out_i,"RefPoint")$MSY[,,-(1:out_i@nyears)]),
# FUN = mean,
# ylabel= expression(mean~(MSY)),
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user4]
# )
# 
# # SSBMSY
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user4,
# myvarName = expression(slot(out_i,"RefPoint")$SSBMSY[,,-(1:out_i@nyears)]),
# FUN = mean,
# ylabel= expression(mean~(SSBMSY)),
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user4]
# )
# 
# # FMSY
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user4,
# myvarName = expression(slot(out_i,"RefPoint")$FMSY[,,-(1:out_i@nyears)]),
# FUN = mean,
# ylabel= expression(mean~(FMSY)),
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user4]
# )
# 
# # UMSY
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user4,
# myvarName = expression(F2U(slot(out_i,"RefPoint")$FMSY[,,-(1:out_i@nyears)])),
# FUN = mean,
# ylabel= expression(mean~(UMSY)),
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user4]
# )
```

```{r plot time series RE,eval=FALSE}
# # VB
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user1,
# myvarName = "VB",
# ylabel = expression(RE~(mean~(VB))),
# FUN = mean, MPNamesRef = "SCA_1",
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user1]
# )

# SSB
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user1,
  myvarName = "SSB",
  ylabel = expression(RE~(mean~(SBB))),
  FUN = mean, MPNamesRef = "SCA_1",
  MPNamesSub = MPNamesSub_user,
  MPNamesSub_legtext=MPNamesSub_user_legtext,
  rowLabs=scenNames_key[scenNames_user1],
  ylim=c(-0.5,0.5)
)
# 
# # F
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user1,  
# myvarName = "FM",
# ylabel = expression(RE~(mean~(F))),
# FUN = mean, MPNamesRef = "SCA_1",
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user1]
# )
# 
# # TAC
# plot_MSE_ts(
# OMNames= OMNames, scenNames=scenNames_user1,  
# myvarName = "TAC",
# ylabel = expression(RE~(mean~(TAC))),
# FUN = mean, MPNamesRef = "SCA_1",
# MPNamesSub = MPNamesSub_user,
# MPNamesSub_legtext=MPNamesSub_user_legtext,
# rowLabs=scenNames_key[scenNames_user1] 
# )

# Catch
plot_MSE_ts(
OMNames= OMNames, scenNames=scenNames_user1,  
myvarName = "Catch",
ylabel = expression(RE~(mean~(Catch))),
FUN = mean, MPNamesRef = "SCA_1",
MPNamesSub = MPNamesSub_user,
MPNamesSub_legtext=MPNamesSub_user_legtext,
rowLabs=scenNames_key[scenNames_user1],
ylim=c(-0.5,0.5)
)

# SSB/SSBmsy
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user1,
  myvarName = "SB_SBMSY",
  ylabel = expression(RE~(mean~(SSB/SSBmsy))),
  FUN = mean, MPNamesRef = "SCA_1",
  MPNamesSub = MPNamesSub_user,
  MPNamesSub_legtext=MPNamesSub_user_legtext,
  rowLabs=scenNames_key[scenNames_user1],
  ylim=c(-0.5,0.5),
  hline=NA
)

# F/Fmsy
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user1,
  myvarName = "F_FMSY",
  ylabel = expression(RE~(mean~(F/Fmsy))),
  FUN = mean, MPNamesRef = "SCA_1",
  MPNamesSub = MPNamesSub_user,
  rowLabs=scenNames_key[scenNames_user1],
  ylim=c(-1,1.5),
  hline=NA
)

# C/MSY
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user1,
  myvarName = "Catch",
  myvarDenomExpr = expression(slot(out_i,"RefPoint")$MSY[,,-(1:out_i@nyears)]),
  ylabel = expression(RE~(mean~(Catch/MSY))),
  FUN = mean, MPNamesRef = "SCA_1",
  MPNamesSub = MPNamesSub_user,
  MPNamesSub_legtext=MPNamesSub_user_legtext,
  rowLabs=scenNames_key[scenNames_user1],
  ylim=c(-0.5,0.5)
)

# 
# # TAC/MSY
# plot_MSE_ts(
#   OMNames= OMNames, scenNames=scenNames_user1,
#   myvarName = "TAC",
#   myvarDenomExpr = expression(slot(out_i,"RefPoint")$MSY[,,-(1:out_i@nyears)]),
#   ylabel = expression(RE~(mean~(TAC/MSY))),
#   FUN = mean, MPNamesRef = "SCA_1",
#   ylim=c(0,2),
#   MPNamesSub = MPNamesSub_user,
#   MPNamesSub_legtext=MPNamesSub_user_legtext,
#   rowLabs=scenNames_key[scenNames_user1],
#   ylim=c(-0.5,0.5),
#   hline=NA
# )
# 
# # C/TAC
# plot_MSE_ts(
#   OMNames= OMNames, scenNames=scenNames_user1,  
#   myvarName = "Catch",
#   myvarDenomExpr = expression(slot(out_i,"TAC")),
#   ylabel = expression(RE~(mean~(C/TAC))),
#   FUN = mean, MPNamesRef = "SCA_1",
#   ylim=c(0,1.1),
#   MPNamesSub = MPNamesSub_user,
#   MPNamesSub_legtext=MPNamesSub_user_legtext,
#   rowLabs=scenNames_key[scenNames_user1],
#   ylim=c(-0.5,0.5),
#   hline=NA
# )
# 
# # MSY
# plot_MSE_ts(
#   OMNames= OMNames, scenNames=scenNames_user1,
#   myvarName = expression(slot(out_i,"RefPoint")$MSY[,,-(1:out_i@nyears)]),
#   FUN = mean, MPNamesRef = "SCA_1",
#   ylabel= expression(RE~(mean~(MSY))),
#   MPNamesSub = MPNamesSub_user,
#   MPNamesSub_legtext=MPNamesSub_user_legtext,
#   rowLabs=scenNames_key[scenNames_user1],
#   ylim=c(-0.5,0.5),
#   hline=NA
# )
# 
# # SSBMSY
# plot_MSE_ts(
#   OMNames= OMNames, scenNames=scenNames_user1,
#   myvarName = expression(slot(out_i,"RefPoint")$SSBMSY[,,-(1:out_i@nyears)]),
#   FUN = mean, MPNamesRef = "SCA_1",
#   ylabel= expression(RE~(mean~(SSBMSY))),
#   MPNamesSub = MPNamesSub_user,
#   MPNamesSub_legtext=MPNamesSub_user_legtext,
#   rowLabs=scenNames_key[scenNames_user1],
#   ylim=c(-0.5,0.5),
#   hline=NA
# )
# 
# # FMSY
# plot_MSE_ts(
#   OMNames= OMNames, scenNames=scenNames_user1,
#   myvarName = expression(slot(out_i,"RefPoint")$FMSY[,,-(1:out_i@nyears)]),
#   FUN = mean, MPNamesRef = "SCA_1",
#   ylabel= expression(RE~(mean~(FMSY))),
#   MPNamesSub = MPNamesSub_user,
#   MPNamesSub_legtext=MPNamesSub_user_legtext,
#   rowLabs=scenNames_key[scenNames_user1],
#   ylim=c(-0.5,0.5),
#   hline=NA
# )
# 
# # UMSY
# plot_MSE_ts(
#   OMNames= OMNames, scenNames=scenNames_user1,
#   myvarName = expression(F2U(slot(out_i,"RefPoint")$FMSY[,,-(1:out_i@nyears)])),
#   FUN = mean, MPNamesRef = "SCA_1",
#   ylabel= expression(RE~(mean~(UMSY))),
#   MPNamesSub = MPNamesSub_user,
#   MPNamesSub_legtext=MPNamesSub_user_legtext,
#   rowLabs=scenNames_key[scenNames_user1],
#   ylim=c(-0.5,0.5),
#   hline=NA
# )
```

```{r plot dot and whiskers, eval=FALSE}
plot_MSE_dw(
    OMNames= OMNames, scenNames=scenNames_user1,
    myvarName = "SSB",
    ylabel = expression(cv~(SSB)),
    FUN = cv,
    MPNamesSub = MPNamesAll,
    MPNamesSub_legtext=MPNamesAll_legtext,
    rowLabs=scenNames_key[scenNames_user1]
)

plot_MSE_dw(
    OMNames= OMNames, scenNames=scenNames_user1,
    myvarName = "Catch",
    myvarDenomExpr = expression(slot(out_i,"RefPoint")$MSY[,,-(1:out_i@nyears)]),
    ylabel = expression(geomean~(Catch/MSY)),
    FUN = geomean,
    MPNamesSub = MPNamesAll,
    MPNamesSub_legtext=MPNamesAll_legtext,
    rowLabs=scenNames_key[scenNames_user1],
    ylim = c(0,1)
)

```

```{r MSEtool tradeoff plots, eval=FALSE}
# MSEtool Tradeoff plots
for(outName_i in MSEoutNames_user1){
out_i <- get(outName_i)  
par(oma=c(1,1,2,1))  
MSEtool::TradePlot(out_i)
}
```

\clearpage

# Tradeoff plots

```{r tr_YldP100_1, eval=TRUE}
if(plot_pdf){pdf("Figs/tr_YldP100_1.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user1,
  plot_type = "tradeoff",
  PMx = Yield,
  PMy = P100,
  MPNamesSub = MPNamesAll,
  MPNamesSub_legtext=MPNamesAll,
  rowLabs=scenNames_key[scenNames_user1],
  mar=c(0,0,0,0),label_axes="leftbottom",
  xlim=c(0,1.2),ylim=c(0,1.1),
  hline=0.5,vline=0.5,cex=2,legend_cex = 1
)
if(plot_pdf){dev.off()}
```

\clearpage

```{r tr_PNOFP100_1, eval=TRUE}
if(plot_pdf){pdf("Figs/tr_PNOFP100_1.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user1,
  plot_type = "tradeoff",
  PMx = PNOF,
  PMy = P100,
  MPNamesSub = MPNamesAll,
  MPNamesSub_legtext=MPNamesAll,
  rowLabs=scenNames_key[scenNames_user1],
  mar=c(0,0,0,0),label_axes="leftbottom",
  xlim=c(0,1.1),ylim=c(0,1.1),
  hline=0.5,vline=0.5,cex=2,legend_cex = 1
)
if(plot_pdf){dev.off()}
```
\clearpage

```{r tr_AAVYP100_1, eval=TRUE}
if(plot_pdf){pdf("Figs/tr_AAVYP100_1.pdf")}
plot_MSE_ts(
  OMNames= OMNames,
  scenNames = scenNames_user1,
  plot_type = "tradeoff",
  PMx = AAVY,
  PMy = P100,  
  MPNamesSub = MPNamesAll,
  MPNamesSub_legtext = MPNamesAll,
  rowLabs=scenNames_key[scenNames_user1],
  mar=c(0,0,0,0), label_axes = "leftbottom",
  xlim=c(0,1.2), ylim=c(0,1.1),
  hline=0.5,vline=0.5,cex=2,legend_cex = 1
)
if(plot_pdf){dev.off()}
```

```{r tr_AAVYPNOF_1, eval=TRUE}
if(plot_pdf){pdf("Figs/tr_AAVYPNOF_1.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user1,
  plot_type = "tradeoff",
  PMx = AAVY,
  PMy = PNOF,
  MPNamesSub = MPNamesAll,
  MPNamesSub_legtext=MPNamesAll,
  rowLabs=scenNames_key[scenNames_user1],
  mar=c(0,0,0,0),label_axes="leftbottom",
  xlim=c(0,1.2),ylim=c(0,1.1),
  hline=0.5,vline=0.5,cex=2,legend_cex = 1
)
if(plot_pdf){dev.off()}
```

\clearpage

# Phase plots

```{r phase plots}
if(plot_pdf){pdf("Figs/phasePlot1.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user1,
  plot_type = "phase",
  proyear_phase=41:50,
  MPNamesSub = c(MPNamesSub_user),
  MPNamesSub_legtext=c(MPNamesSub_user_legtext),
  rowLabs=scenNames_key[scenNames_user1],
  mar=c(0,0,0,0),label_axes="leftbottom",
  xlim=c(0,5),ylim=c(0,5),
  hline=NA
)
if(plot_pdf){dev.off()}

if(plot_pdf){pdf("Figs/phasePlot2.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user2,
  plot_type = "phase",
  proyear_phase=41:50,
  MPNamesSub = c(MPNamesSub_user),
  MPNamesSub_legtext=c(MPNamesSub_user_legtext),
  rowLabs=scenNames_key[scenNames_user2],
  mar=c(0,0,0,0),label_axes="leftbottom",
  xlim=c(0,5),ylim=c(0,5),
  hline=NA
)
if(plot_pdf){dev.off()}

if(plot_pdf){pdf("Figs/phasePlot3.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user3,
  plot_type = "phase",
  proyear_phase=41:50,
  MPNamesSub = c(MPNamesSub_user),
  MPNamesSub_legtext=c(MPNamesSub_user_legtext),
  rowLabs=scenNames_key[scenNames_user3],
  mar=c(0,0,0,0),label_axes="leftbottom",
  xlim=c(0,5),ylim=c(0,5),
  hline=NA
)

if(plot_pdf){pdf("Figs/phasePlot4.pdf")}
plot_MSE_ts(
  OMNames= OMNames, scenNames=scenNames_user4,
  plot_type = "phase",
  proyear_phase=41:50,
  MPNamesSub = c(MPNamesSub_user),
  MPNamesSub_legtext=c(MPNamesSub_user_legtext),
  rowLabs=scenNames_key[scenNames_user4],
  mar=c(0,0,0,0),label_axes="leftbottom",
  xlim=c(0,5),ylim=c(0,5),
  hline=NA
)
if(plot_pdf){dev.off()}
```




